#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const readline = require('readline');

// The directory where antigravity-setup is installed (e.g., project/.agent/antigravity-setup)
const SETUP_DIR = path.resolve(__dirname, '..');
// The project root (parent of .agent/antigravity-setup, or parent of setup dir)
// Assumption: install.js installs to [ProjectRoot]/.agent/antigravity-setup
// So ProjectRoot is ../../ form SETUP_DIR
const PROJECT_ROOT = path.resolve(SETUP_DIR, '../../');

const CONTEXT_FILE = path.join(PROJECT_ROOT, 'AGENTS.md');

const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
});

function askQuestion(query) {
    return new Promise(resolve => rl.question(query, resolve));
}

function generateContext() {
    // Relative path from ProjectRoot to SetupDir
    const relativeSetupPath = path.relative(PROJECT_ROOT, SETUP_DIR).replace(/\\/g, '/');

    return `
# Antigravity Agent Configuration
# Automatically generated by antigravity-setup

# 1. Identity & Protocol
You are an autonomous agent operating under the **Antigravity Protocol**.
Your goal is to build high-quality software by strictly following defined roles and workflows.

# 2. Context Loading
You MUST load and adhere to the following configurations:
- **Roles**: \`${relativeSetupPath}/agents/roles.yaml\`
- **Workflow**: \`${relativeSetupPath}/agents/workflow.md\`
- **Tech Stack**: \`${relativeSetupPath}/rules/tech_stack.md\` (Generated Context)
- **Language Rules**: \`${relativeSetupPath}/rules/00_language.rules.md\`

# 3. Behavior Guidelines
- **Plan First**: Always use \`/plan\` before starting complex work.
- **Vibe Coding**: Follow the "Think-Run-Feedback" loop. Don't write too much without running.
- **MSA**: Keep agents and tools modular (\`rules/msa_architecture.rules.md\`).

# 4. Commands
- \`/plan\`: Start a new task.
- \`/tdd\`: Implement features (Red-Green-Refactor).
- \`/verify\`: Check quality.
- \`/learn\`: Save lessons.
- \`/trend\`: Check latest trends.

# 5. Tools
- Use the provided MCP tools and Slash Commands defined in \`${relativeSetupPath}/tools/commands.md\`.
`;
}

async function configureGitProvider() {
    console.log('\nüîó Configure Git Provider (MCP)');
    console.log('1) GitHub (Default)');
    console.log('2) Gitea');
    console.log('3) Skip');

    const choice = await askQuestion('Select Provider [1-3]: ');
    const mcpConfigPath = path.join(SETUP_DIR, 'mcp', 'mcp_config.json');

    if (!fs.existsSync(mcpConfigPath)) {
        console.warn('‚ö†Ô∏è mcp_config.json not found. Skipping MCP config.');
        return;
    }

    const mcpConfig = JSON.parse(fs.readFileSync(mcpConfigPath, 'utf8'));

    if (choice === '2') { // Gitea
        const giteaUrl = await askQuestion('Enter Gitea URL (e.g., https://gitea.com): ');
        const giteaToken = await askQuestion('Enter Gitea Access Token: ');

        console.log('\nSelect Gitea Execution Mode:');
        console.log('1) Docker (Recommended if installed)');
        console.log('2) Local Binary');
        const mode = await askQuestion('Select Mode [1-2]: ');

        // Remove GitHub if exists
        if (mcpConfig.mcpServers && mcpConfig.mcpServers.github) {
            delete mcpConfig.mcpServers.github;
        }

        if (mode === '2') { // Binary
            const binPath = await askQuestion('Enter absolute path to Gitea MCP binary: ');
            mcpConfig.mcpServers.gitea = {
                command: binPath,
                args: ["-t", "stdio", "--host", giteaUrl],
                env: {
                    "GITEA_ACCESS_TOKEN": giteaToken
                }
            };
        } else { // Docker (Default)
            mcpConfig.mcpServers.gitea = {
                command: "docker",
                args: [
                    "run", "-i", "--rm",
                    "-e", "GITEA_ACCESS_TOKEN",
                    "-e", "GITEA_HOST",
                    "docker.gitea.com/gitea-mcp-server"
                ],
                env: {
                    "GITEA_ACCESS_TOKEN": giteaToken,
                    "GITEA_HOST": giteaUrl
                }
            };
        }
        console.log('‚úÖ Gitea MCP configured.');

    } else if (choice === '3') { // Skip
        console.log('   Skipping Git provider configuration.');
        // Optionally disable github if previously enabled? 
        // For now, leave as is or remove if user explicitly wants to skip/disable.
        // Let's remove default github to be safe if they skip.
        if (mcpConfig.mcpServers && mcpConfig.mcpServers.github) {
            // delete mcpConfig.mcpServers.github; 
            // Actually, skipping might mean "don't change anything", but usually implies "I don't have one".
            // Let's keep it simple: Skip = Do nothing.
        }

    } else { // GitHub (Default)
        const token = await askQuestion('Enter GitHub Personal Access Token (Press Enter to set later): ');
        if (token.trim()) {
            if (mcpConfig.mcpServers && mcpConfig.mcpServers.github) {
                mcpConfig.mcpServers.github.env.GITHUB_PERSONAL_ACCESS_TOKEN = token.trim();
                console.log('‚úÖ GitHub Token configured.');
            }
        } else {
            console.log('   Token not provided. Please set GITHUB_PERSONAL_ACCESS_TOKEN in mcp_config.json later.');
        }
    }

    fs.writeFileSync(mcpConfigPath, JSON.stringify(mcpConfig, null, 2));
}


async function main() {
    console.log(`\n‚öôÔ∏è  Configuring Antigravity Context...`);
    console.log(`   Project Root detected at: ${PROJECT_ROOT}`);
    console.log(`   Antigravity installed at: ${SETUP_DIR}`);

    // Context Analysis & Git Detection logic could be here, but we are overriding with interactive config.

    // Interactive Git Configuration
    await configureGitProvider();

    const contextContent = generateContext();

    if (fs.existsSync(CONTEXT_FILE)) {
        console.log(`\n‚ö†Ô∏è  AGENTS.md already exists at ${CONTEXT_FILE}`);
        const answer = await askQuestion('   Overwrite it? (y/N): ');
        if (answer.toLowerCase() === 'y') {
            fs.writeFileSync(CONTEXT_FILE, contextContent);
            console.log('‚úÖ AGENTS.md updated.');
        } else {
            console.log('   Skipping configuration.');
        }
    } else {
        const answer = await askQuestion(`\nüìù Create AGENTS.md in project root? (Y/n): `);
        if (answer.toLowerCase() !== 'n') {
            fs.writeFileSync(CONTEXT_FILE, contextContent);
            console.log('‚úÖ AGENTS.md created. Point your LLM to this file context!');
        } else {
            console.log('   Skipped.');
        }
    }

    rl.close();
}

main();
