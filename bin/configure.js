#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const readline = require('readline');

// The directory where antigravity-setup is installed (e.g., project/.agent/antigravity-setup)
const SETUP_DIR = path.resolve(__dirname, '..');
// The project root (parent of .agent/antigravity-setup, or parent of setup dir)
// Assumption: install.js installs to [ProjectRoot]/.agent/antigravity-setup
// So ProjectRoot is ../../ form SETUP_DIR
const PROJECT_ROOT = path.resolve(SETUP_DIR, '../../');

const CONTEXT_FILE = path.join(PROJECT_ROOT, 'AGENTS.md');

const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
});

function generateContext() {
    // Relative path from ProjectRoot to SetupDir
    const relativeSetupPath = path.relative(PROJECT_ROOT, SETUP_DIR).replace(/\\/g, '/');

    return `
# Antigravity Agent Configuration
# Automatically generated by antigravity-setup

# 1. Identity & Protocol
You are an autonomous agent operating under the **Antigravity Protocol**.
Your goal is to build high-quality software by strictly following defined roles and workflows.

# 2. Context Loading
You MUST load and adhere to the following configurations:
- **Roles**: \`${relativeSetupPath}/agents/roles.yaml\`
- **Workflow**: \`${relativeSetupPath}/agents/workflow.md\`
- **Tech Stack**: \`${relativeSetupPath}/rules/tech_stack.md\` (Generated Context)
- **Language Rules**: \`${relativeSetupPath}/rules/00_language.rules.md\`

# 3. Behavior Guidelines
- **Plan First**: Always use \`/plan\` before starting complex work.
- **Vibe Coding**: Follow the "Think-Run-Feedback" loop. Don't write too much without running.
- **MSA**: Keep agents and tools modular (\`rules/msa_architecture.rules.md\`).

# 4. Commands
- \`/plan\`: Start a new task.
- \`/tdd\`: Implement features (Red-Green-Refactor).
- \`/verify\`: Check quality.
- \`/learn\`: Save lessons.
- \`/trend\`: Check latest trends.

# 5. Tools
- Use the provided MCP tools and Slash Commands defined in \`${relativeSetupPath}/tools/commands.md\`.
`;
}

async function main() {
    console.log(`\nâš™ï¸  Configuring Antigravity Context...`);
    console.log(`   Project Root detected at: ${PROJECT_ROOT}`);
    console.log(`   Antigravity installed at: ${SETUP_DIR}`);

    // Check Git Status from tech_stack.md
    const techStackPath = path.join(SETUP_DIR, 'rules', 'tech_stack.md');
    let hasGit = true;
    if (fs.existsSync(techStackPath)) {
        const content = fs.readFileSync(techStackPath, 'utf8');
        if (content.includes('VCS: None')) {
            hasGit = false;
        }
    }

    // Configure MCP
    if (!hasGit) {
        console.log('\nðŸš« No Git repository detected. Disabling GitHub MCP...');
        const mcpConfigPath = path.join(SETUP_DIR, 'mcp', 'mcp_config.json');
        if (fs.existsSync(mcpConfigPath)) {
            try {
                const mcpConfig = JSON.parse(fs.readFileSync(mcpConfigPath, 'utf8'));
                if (mcpConfig.mcpServers && mcpConfig.mcpServers.github) {
                    delete mcpConfig.mcpServers.github; // Remove github server
                    fs.writeFileSync(mcpConfigPath, JSON.stringify(mcpConfig, null, 2));
                    console.log('âœ… GitHub MCP disabled in mcp_config.json');
                }
            } catch (e) {
                console.warn('âš ï¸ Failed to update mcp_config.json:', e.message);
            }
        }
    } else {
        console.log('\nâœ… Git repository detected. GitHub MCP enabled.');
    }

    const contextContent = generateContext();

    if (fs.existsSync(CONTEXT_FILE)) {
        console.log(`\nâš ï¸  AGENTS.md already exists at ${CONTEXT_FILE}`);
        rl.question('   Overwrite it? (y/N): ', (answer) => {
            if (answer.toLowerCase() === 'y') {
                fs.writeFileSync(CONTEXT_FILE, contextContent);
                console.log('âœ… AGENTS.md updated.');
            } else {
                console.log('   Skipping configuration.');
            }
            rl.close();
        });
    } else {
        rl.question(`\nðŸ“ Create AGENTS.md in project root? (Y/n): `, (answer) => {
            if (answer.toLowerCase() !== 'n') {
                fs.writeFileSync(CONTEXT_FILE, contextContent);
                console.log('âœ… AGENTS.md created. Point your LLM to this file context!');
            } else {
                console.log('   Skipped.');
            }
            rl.close();
        });
    }
}

main();
