#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const readline = require('readline');

// The directory where antigravity-setup is installed (e.g., project/.agent/antigravity-setup)
const SETUP_DIR = path.resolve(__dirname, '..');
// The project root (parent of .agent/antigravity-setup, or parent of setup dir)
// Assumption: install.js installs to [ProjectRoot]/.agent/antigravity-setup
// So ProjectRoot is ../../ form SETUP_DIR
const PROJECT_ROOT = path.resolve(SETUP_DIR, '../../');

const CURSOR_RULES_FILE = path.join(PROJECT_ROOT, 'AGENTS.md');

const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
});

function generateCursorRules() {
    // Relative path from ProjectRoot to SetupDir
    const relativeSetupPath = path.relative(PROJECT_ROOT, SETUP_DIR).replace(/\\/g, '/');

    return `
# Antigravity Agent Configuration
# Automatically generated by antigravity-setup

# 1. Identity & Protocol
You are an autonomous agent operating under the **Antigravity Protocol**.
Your goal is to build high-quality software by strictly following defined roles and workflows.

# 2. Context Loading
You MUST load and adhere to the following configurations:
- **Roles**: \`${relativeSetupPath}/agents/roles.yaml\`
- **Workflow**: \`${relativeSetupPath}/agents/workflow.md\`
- **Tech Stack**: \`${relativeSetupPath}/rules/tech_stack.md\` (Generated Context)
- **Language Rules**: \`${relativeSetupPath}/rules/00_language.rules.md\`

# 3. Behavior Guidelines
- **Plan First**: Always use \`/plan\` before starting complex work.
- **Vibe Coding**: Follow the "Think-Run-Feedback" loop. Don't write too much without running.
- **MSA**: Keep agents and tools modular (\`rules/msa_architecture.rules.md\`).

# 4. Commands
- \`/plan\`: Start a new task.
- \`/tdd\`: Implement features (Red-Green-Refactor).
- \`/verify\`: Check quality.
- \`/learn\`: Save lessons.
- \`/trend\`: Check latest trends.

# 5. Tools
- Use the provided MCP tools and Slash Commands defined in \`${relativeSetupPath}/tools/commands.md\`.
`;
}

async function main() {
    console.log(`\nâš™ï¸  Configuring Antigravity Context...`);
    console.log(`   Project Root detected at: ${PROJECT_ROOT}`);
    console.log(`   Antigravity installed at: ${SETUP_DIR}`);

    const rulesContent = generateCursorRules();

    if (fs.existsSync(CURSOR_RULES_FILE)) {
        console.log(`\nâš ï¸  AGENTS.md already exists at ${CURSOR_RULES_FILE}`);
        rl.question('   Overwrite it? (y/N): ', (answer) => {
            if (answer.toLowerCase() === 'y') {
                fs.writeFileSync(CURSOR_RULES_FILE, rulesContent);
                console.log('âœ… AGENTS.md updated.');
            } else {
                console.log('   Skipping configuration.');
            }
            rl.close();
        });
    } else {
        rl.question(`\nðŸ“ Create AGENTS.md in project root? (Y/n): `, (answer) => {
            if (answer.toLowerCase() !== 'n') {
                fs.writeFileSync(CURSOR_RULES_FILE, rulesContent);
                console.log('âœ… AGENTS.md created. Point your LLM to this file context!');
            } else {
                console.log('   Skipped.');
            }
            rl.close();
        });
    }
}

main();
